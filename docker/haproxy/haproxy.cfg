global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 5000
    timeout client 50000
    timeout server 50000

# Stats interface
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-node
    stats show-legends

# Frontend for HTTP traffic
frontend http_front
    bind *:80
    default_backend nginx_back
    
    # Health check endpoint
    acl is_health path /health
    use_backend health_back if is_health

# Backend for health checks
backend health_back
    http-request return status 200 content-type text/plain string "healthy\n"

# Backend for nginx proxies
backend nginx_back
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server nginx-proxy-1 nginx-proxy-1:8080 check inter 5s fall 3 rise 2
    server nginx-proxy-2 nginx-proxy-2:8080 check inter 5s fall 3 rise 2
